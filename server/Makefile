# AGV MQTT ν΄λΌμ΄μ–ΈνΈ μ„λ²„ Makefile

# μ»΄νμΌλ¬ μ„¤μ •
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -O2 -pthread

# λΌμ΄λΈλ¬λ¦¬ μ„¤μ •
LIBS = -lmosquitto -ljson

# μ†μ¤ νμΌ
SRCFILE = server.cpp

# μ‹¤ν–‰ νμΌ μ΄λ¦„
TARGET = mqtt_server

# κΈ°λ³Έ νƒ€κ²
all: $(TARGET)

# μ‹¤ν–‰ νμΌ λΉλ“
$(TARGET): $(SRCFILE)
	$(CXX) $(CXXFLAGS) -o $(TARGET) $(SRCFILE) $(LIBS)
	@echo "β… MQTT ν΄λΌμ΄μ–ΈνΈ μ„λ²„ λΉλ“ μ™„λ£: $(TARGET)"

# μμ΅΄μ„± μ„¤μΉ (Ubuntu/Debian)
install-deps:
	@echo "π“¦ μμ΅΄μ„± μ„¤μΉ μ¤‘..."
	sudo apt-get update
	sudo apt-get install -y \
		g++ \
		libmosquitto-dev \
		nlohmann-json3-dev \
		mosquitto-clients
	@echo "β… μμ΅΄μ„± μ„¤μΉ μ™„λ£"

# μ„λ²„ μ‹¤ν–‰
run: $(TARGET)
	@echo "π€ MQTT ν΄λΌμ΄μ–ΈνΈ μ„λ²„ μ‹¤ν–‰ μ¤‘..."
	@echo "μ£Όμ: μ™Έλ¶€ MQTT λΈλ΅μ»¤κ°€ μ‹¤ν–‰ μ¤‘μΈμ§€ ν™•μΈν•μ„Έμ”"
	./$(TARGET)

# MQTT μ—°κ²° ν…μ¤νΈ (μ™Έλ¶€ λΈλ΅μ»¤ ν•„μ”)
test:
	@echo "π§ MQTT μ—°κ²° ν…μ¤νΈ..."
	@echo "μ™Έλ¶€ MQTT λΈλ΅μ»¤ μ£Όμ†λ¥Ό ν™•μΈν•μ„Έμ”"
	mosquitto_pub -h mqtt.broker.address -t "test/topic" -m "Hello MQTT" -u central_server -P AgvServer2025!

# μ²­μ†
clean:
	rm -f $(TARGET)
	@echo "π§Ή λΉλ“ νμΌ μ •λ¦¬ μ™„λ£"

# λ„μ›€λ§
help:
	@echo "AGV MQTT ν΄λΌμ΄μ–ΈνΈ μ„λ²„ λΉλ“ μ‹μ¤ν…"
	@echo ""
	@echo "β οΈ  μ£Όμμ‚¬ν•­: λ³„λ„μ MQTT λΈλ΅μ»¤ μ„λ²„κ°€ ν•„μ”ν•©λ‹λ‹¤"
	@echo ""
	@echo "μ‚¬μ© κ°€λ¥ν• λ…λ Ήμ–΄:"
	@echo "  make              - μ„λ²„ λΉλ“"
	@echo "  make install-deps - μμ΅΄μ„± μ„¤μΉ"
	@echo "  make run          - μ„λ²„ μ‹¤ν–‰"
	@echo "  make test         - MQTT μ—°κ²° ν…μ¤νΈ"
	@echo "  make clean        - λΉλ“ νμΌ μ •λ¦¬"
	@echo "  make help         - μ΄ λ„μ›€λ§ ν‘μ‹"
	@echo ""
	@echo "μ„¤μΉ μμ„:"
	@echo "  1. μ™Έλ¶€ MQTT λΈλ΅μ»¤ μ„λ²„ μ¤€λΉ„"
	@echo "  2. server.cppμ—μ„ λΈλ΅μ»¤ μ£Όμ† μμ •"
	@echo "  3. make install-deps"
	@echo "  4. make"
	@echo "  5. make run"

.PHONY: all install-deps run test clean help